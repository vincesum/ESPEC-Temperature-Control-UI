{% extends 'base.html' %}
{% block head %}
<Title>ESPEC Temperature Chamber Controller</Title>
{% endblock %}
{% block body %}
<header class="navbar-container">
    <h1 class="logo" style="font-size: 40px">ESPEC Temperature Chamber Controller</h1>
    <nav class="nav-links">
        <a href="/" class="btn1">Soaking Mode</a>
        <a href="/cycle" class="btn2">Cycling Mode</a>
    </nav>
</header>

<main>
    <div class="container">
    <div class="left">
    <div class="input-group">
        <h2>Add New Task</h2>
        
        <div style="display: flex; gap: 10px; margin: 0px; border: 0px; padding: 0px;">
            <input type="number" id="newTemp1" list="tempOptions" placeholder="Temp 1(°C)" style="width: 100px;">
            <input type="number" id="newTemp2" list="tempOptions" placeholder="Temp 2(°C)" style="width: 100px;">
            
            <datalist id="tempOptions">
                <option value="0"></option>
                <option value="5"></option>
                <option value="10"></option>
                <option value="15"></option>
                <option value="20"></option>
                <option value="25"></option>
                <option value="30"></option>
                <option value="35"></option>
                <option value="40"></option>
                <option value="45"></option>
                <option value="50"></option>
                <option value="55"></option>
                <option value="60"></option>
                <option value="65"></option>
                <option value="70"></option>
                <option value="75"></option>
                <option value="80"></option>
                <option value="85"></option>
                <option value="90"></option>
                <option value="95"></option>
                <option value="100"></option>
            </datalist>

            <input type="number" id="newHrs" list="hourOptions" placeholder="Hrs" style="width: 80px;">

            <datalist id="hourOptions">
                <option value="0"></option>
                <option value="1"></option>
                <option value="2"></option>
                <option value="3"></option>
                <option value="4"></option>
                <option value="5"></option>
                <option value="6"></option>
                <option value="7"></option>
                <option value="8"></option>
                <option value="9"></option>
                <option value="10"></option>
                <option value="11"></option>
                <option value="12"></option>
                <option value="13"></option>
                <option value="14"></option>
                <option value="15"></option>
                <option value="16"></option>
                <option value="17"></option>
                <option value="18"></option>
                <option value="19"></option>
                <option value="20"></option>
                <option value="21"></option>
                <option value="22"></option>
                <option value="23"></option>
                <option value="24"></option>
            </datalist>

            <input type="number" id="newMin" list="minOptions" placeholder="Mins" style="width: 80px;">
            
            <datalist id="minOptions">
                <option value="0"></option>
                <option value="5"></option>
                <option value="10"></option>
                <option value="15"></option>
                <option value="20"></option>
                <option value="25"></option>
                <option value="30"></option>
                <option value="35"></option>
                <option value="40"></option>
                <option value="45"></option>
                <option value="50"></option>
                <option value="55"></option>
            </datalist>
            
            <input type="number" id="newSec" list="secOptions" placeholder="Secs" style="width: 80px;">
            
            <datalist id="secOptions">
                <option value="0"></option>
                <option value="5"></option>
                <option value="10"></option>
                <option value="15"></option>
                <option value="20"></option>
                <option value="25"></option>
                <option value="30"></option>
                <option value="35"></option>
                <option value="40"></option>
                <option value="45"></option>
                <option value="50"></option>
                <option value="55"></option>
            </datalist>

             <input type="number" id="newCycles" list="cycleOptions" placeholder="No. of Cycles" style="width: 115px;">
            
            <datalist id="cycleOptions">
                <option value="1"></option>
                <option value="2"></option>
                <option value="3"></option>
                <option value="4"></option>
                <option value="5"></option>
                <option value="6"></option>
                <option value="7"></option>
                <option value="8"></option>
                <option value="9"></option>
                <option value="10"></option>
                <option value="11"></option>
                <option value="12"></option>
            </datalist>
        </div>


        <button class="addbtn" onclick="sendNewTask()" style="font-size: 18px; margin-top: 10px; border: none; padding: 10px; cursor: pointer;">
            + Add Task
        </button>  

    </div>
        <table>
            <tr>
                <th>Tasklist</th>
            </tr>
            
            <tbody id="task-table-body">
                {% for task in tasks %}
                    {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="right">
        <h2>
            <div> <span id="task-display">Loading current task...</span></div>
        </h2>
        <span id="temptime" style="display: flex;">
            <div>Time Left: <span id="time">00:00:00</span></div>
            <div>Current Temp: <span id="current-temp">{{ current_temp }}</span>°C</div>
            <div> <span id="current-cycle"> </span></div>
        </span>

        <div id="startstop" style="display: flex; gap: 20px; margin-top: 20px;">
            <button onclick="sendStartCommand(this)" class="greenbtn" style="font-size: 30px; margin: 10px 30px 10px 30px; border: none; padding: 10px;" {% if current_task %} disabled {% endif %}>Start</button>
            <script>
                async function sendStartCommand(btn) {
                    try {
                        let response = await fetch('/api/start');

                        if (response.ok) {
                            window.location.reload(); 
                        } else {
                            let errorMessage = await response.text();
                            alert("Error: " + errorMessage);
                        }
                    } catch (error) {
                        console.error("Network Error:", error);
                        alert("Failed to connect to the oven controller.");
                    }
                }
            </script>
            <button onclick="sendStopCommand(this)" class="redbtn" style="font-size: 30px; margin: 10px 30px 10px 30px; border: none; padding: 10px;" {% if not current_task %} disabled {% endif %}>Stop</button>
            <script>
                async function sendStopCommand(btn) {
                    try {
                        let response = await fetch('/api/stop');

                        if (response.ok) {
                            window.location.reload(); 
                        } else {
                            let errorMessage = await response.text();
                            alert("Error: " + errorMessage);
                        }
                    } catch (error) {
                        console.error("Network Error:", error);
                        alert("Failed to connect to the oven controller.");
                    }
                }
            </script>
        </div>
    </div>

</main>

<script>
    async function sendNewTask() {
    // 1. Grab the values from the HTML boxes
    const tempVal1 = document.getElementById('newTemp1').value;
    const tempVal2 = document.getElementById('newTemp2').value;
    const hrsVal = document.getElementById('newHrs').value || 0; // Default to 0 if empty
    const minVal = document.getElementById('newMin').value || 0;
    const secVal = document.getElementById('newSec').value || 0;
    const cycleVal = document.getElementById('newCycles').value || 1;

    // 2. Safety Check
    if (!tempVal1 || !tempVal2) {
        alert("Please enter both temperatures!");
        return;
    }

    if (Number(minVal) > 59) {
        alert("Error, minutes cannot exceed 59!");
        return;
    }

    if (Number(secVal) > 59) {
        alert("Error, seconds cannot exceed 59!");
        return;
    }

    if (Number(secVal) + Number(minVal) + Number(hrsVal) <= 0) {
        alert("Error, time cannot be set below or equal 0.")
        return;
    }

    if (Number(cycleVal) <= 0) {
        alert("Error, number of cycles must be at least 1.")
        return;
    }

    //Network Request
    try {
        const response = await fetch('/api/add_task', {
            method: 'POST',
            //Sending JSON
            headers: {
                'Content-Type': 'application/json'
            },
            //Bundle the data into a text string
            body: JSON.stringify({
                mode: "cycle",
                temp1: tempVal1,
                temp2: tempVal2,
                hours: hrsVal,
                minutes: minVal,
                seconds: secVal,
                cycles: cycleVal
            })
        });

        // 4. Handle the Result
        const data = await response.json();
        
        if (data.status === 'success') {
            console.log("Task added!");
            //Clear the boxes so the user can type again
            document.getElementById('newTemp1').value = "";
            document.getElementById('newTemp2').value = "";

            //Refresh table to reflect changes
            window.location.reload();
        } else {
            alert("Error from server: " + data.message);
        }

    } catch (error) {
        console.error("Network Error:", error);
        alert("Failed to connect to the oven controller.");
    }
}

let activeTimerInterval = null;
function startTimer(duration, startTime, display) {
    if (activeTimerInterval) {
        clearInterval(activeTimerInterval);
    }
    function timer() {
        var elapsed = (Date.now() - (startTime * 1000)) / 1000;
        var diff = duration - elapsed;  
        
        if (diff <= 0) {
            clearInterval(activeTimerInterval);
            display.textContent = "00:00:00";
            isTimerRunning = false
            return;
        }

        hours = (diff / 3600) | 0;
        minutes = ((diff % 3600) / 60) | 0;
        seconds = (diff % 60) | 0;

        hours = hours < 10 ? "0" + hours : hours;
        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;

        display.textContent = hours + ":" + minutes + ":" + seconds; 

    };
    timer();
    var activeTimerInterval = setInterval(timer, 1000)
}
    let currentQueueString = "";
    let isTimerRunning = false; 
    let activeTimerStartTime = 0;
    async function checkOvenStatus() {
        try {
            // 1. Ask the server for the live status
            let response = await fetch('/api/status');
            let data = await response.json();
            
            let display = document.querySelector('#time');

            // 2. Check the conditions
            if (data.state === "SOAKING" && data.start_time !== -1) {
                
                // If it is soaking, start timer
                if (!isTimerRunning || activeTimerStartTime !== data.start_time) {
                    console.log("Oven reached SOAKING temp! Initializing Timer...");
                    
                    if (typeof startTimer === "function") {
                        startTimer(data.duration, data.start_time, display);
                        isTimerRunning = true; // Lock the door
                        activeTimerStartTime = data.start_time;
                    }
                }
            } else {
                // If it goes back to IDLE or HEATING, reset our lock
                if (isTimerRunning) {
                    console.log("Task stopped or finished.");
                    isTimerRunning = false; // Unlock so the NEXT task can run
                    display.textContent = "00:00:00";
                    activeTimerStartTime = 0;
                }
            }

            let currentTempDisplay = document.querySelector('#current-temp');
            currentTempDisplay.textContent = data.temperature;

            let taskdisplay = document.querySelector('#task-display');
            if (data.type == "Task") {
                taskdisplay.textContent = `Current task: Soak at ${data.set_temp}°C for ${data.hour}hr ${data.min}min ${data.sec}sec`;
            } else if (data.type == "Idle") {
                taskdisplay.textContent = `Current task: Idle for ${data.hour}hr ${data.min}min ${data.sec}sec`;
            } else if (data.type == "Cycle") {
                if (data.cycles == 1) {
                    taskdisplay.textContent = `Current task: Cycle between ${data.set_temp}°C and ${data.set_temp1}°C for ${data.hour}hr ${data.min}min ${data.sec}sec`;
                } else {
                    taskdisplay.textContent = `Current task: ${data.cycles} Cycles between ${data.set_temp}°C and ${data.set_temp1}°C for ${data.hour}hr ${data.min}min ${data.sec}sec`;
                }
            } else {
                taskdisplay.textContent = "No active task."
            }

            let currentCycleDisplay = document.querySelector('#current-cycle');
            if (data.type == "Cycle") {
                currentCycleDisplay.textContent = `Cycle ${data.currCycles} out of ${data.cycles}`;
            }
            else {
                currentCycleDisplay.textContent = "";
            }

            let start_button = document.querySelector(".greenbtn");
            let stop_button = document.querySelector(".redbtn");
            
            //Indicates there is no task running
            if (data.id === -1) {
                start_button.disabled = false;
                stop_button.disabled = true;
            } else {
                start_button.disabled = true;
                stop_button.disabled = false;
            }

            let newQueueString = JSON.stringify(data.queue);

            // Only redraw the table if the queue actually changed (e.g., a task finished or was added)
            if (newQueueString !== currentQueueString) {
                currentQueueString = newQueueString;
                let tbody = document.querySelector('#task-table-body');
                let newHTML = '';

                // Loop through the array Python sent us
                data.queue.forEach((task, index) => {
                    let taskText = '';
                    if (task.type === "Task") {
                        taskText = `Soak at ${task.temp}°C for ${task.hour}hr ${task.min}min ${task.sec}sec`;
                    } else if (task.type === "Idle") {
                        taskText = `Idle for ${task.hour}hr ${task.min}min ${task.sec}sec`;
                    }
                    else if (task.type === "Cycle") {
                        if (task.cycles == 1) {
                            taskText = `Cycle between ${task.temp}°C and ${task.temp1}°C for ${task.hour}hr ${task.min}min ${task.sec}sec`;
                        } else {
                        taskText = `${task.cycles} Cycles between ${task.temp}°C and ${task.temp1}°C for ${task.hour}hr ${task.min}min ${task.sec}sec`;
                    }
                }

                // Build the HTML for each row
                newHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            ${taskText}
                            <a href="/api/delete/${task.id}">
                                <button>Delete</button>
                            </a>   
                        </td>
                    </tr>
                `;
            });

            // Replace the old HTML with the new dynamic HTML
            tbody.innerHTML = newHTML;
        }

        } catch (error) {
            console.error("Failed to fetch oven status:", error);
        }
    }

    // 3. Start the continuous polling loop as soon as the page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Connecting to live status feed...");
        checkOvenStatus(); // Check immediately on load
        // Call checkOvenStatus() every 1000 milliseconds (1 second)
        setInterval(checkOvenStatus, 1000); 
        setInterval(() => {fetch('/api/heartbeat').catch((error) => {
            // If the fetch fails, it just means the server is already dead.
            console.log("Heartbeat failed, server might be offline.");
            });
        }, 2000);
    });

</script>


{% endblock %}